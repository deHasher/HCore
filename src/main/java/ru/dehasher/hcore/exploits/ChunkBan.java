package ru.dehasher.hcore.exploits;

import org.bukkit.entity.Entity;
import org.bukkit.entity.ItemFrame;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;

import org.bukkit.event.block.BlockPlaceEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import ru.dehasher.hcore.HCore;
import ru.dehasher.hcore.managers.Informer;

import java.util.ArrayList;
import java.util.List;

public class ChunkBan implements Listener {

    private static int max_blocks;
    private static int max_heads;

    public ChunkBan(HCore plugin) {
        max_blocks = HCore.config.getInt("fix-exploits.chunk-ban.max.blocks");
        max_heads  = HCore.config.getInt("fix-exploits.chunk-ban.max.heads");
    }

    @EventHandler(priority = EventPriority.HIGHEST)
    public void onBlockPlaceEvent(BlockPlaceEvent e) {
        if (!HCore.config.getBoolean("fix-exploits.chunk-ban.enabled")) return;
        for (String block : HCore.config.getStringList("fix-exploits.chunk-ban.blocks")) {
            if (e.getBlock().getType().name().equals(block)) {
                if (e.getBlock().getChunk().getTileEntities().length > max_blocks) {
                    Informer.send(e.getPlayer(), HCore.lang.getString("errors.chunk-ban")
                            .replace("{max}", "" + max_blocks)
                    );
                    e.setCancelled(true);
                    return;
                }
            }
        }
        for (String block : HCore.config.getStringList("fix-exploits.chunk-ban.heads")) {
            if (e.getBlock().getType().name().equals(block)) {
                if (e.getBlock().getChunk().getTileEntities().length > max_heads) {
                    Informer.send(e.getPlayer(), HCore.lang.getString("errors.chunk-ban")
                            .replace("{max}", "" + max_heads)
                    );
                    e.setCancelled(true);
                }
            }
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPlayerInteractEvent(PlayerInteractEvent e) {
        if (!HCore.config.getBoolean("fix-exploits.chunk-ban.enabled")) return;
        if (e.getAction() == Action.RIGHT_CLICK_BLOCK && e.getItem() != null) {
            if (e.getItem().getType().name().equals(HCore.config.getString("fix-exploits.chunk-ban.frame"))) {
                List<Entity> frames = new ArrayList<>();
                for (Entity entity : e.getClickedBlock().getChunk().getEntities()) {
                    if (entity instanceof ItemFrame) {
                        frames.add(entity);
                    }
                }
                if (frames.size() > max_blocks) {
                    Informer.send(e.getPlayer(), HCore.lang.getString("errors.chunk-ban")
                            .replace("{max}", "" + max_blocks)
                    );
                    e.setCancelled(true);
                }
            }
        }
    }
}
